<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Intelligent Document Assistant</title>
    <link rel="stylesheet" href="/static/style.css" />
    <style>
      body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f7f8fb; color:#111; }
      .container { max-width:1200px; margin:28px auto; padding:18px; }
      h1 { margin:0 0 18px 0; font-size:28px; }
      .grid-3 { display:grid; grid-template-columns: 1fr 1fr 360px; gap:18px; align-items:start; }
      .card { background:#fff; border-radius:10px; padding:16px; box-shadow:0 6px 20px rgba(8,15,36,0.06); }
      textarea { width:100%; resize:vertical; min-height:160px; max-height:420px; }
      .muted { color:#666; font-size:0.9rem; }
      .btn { padding:8px 12px; border-radius:8px; cursor:pointer; border:1px solid #d0d7de; background:#fafbff; }
      .btn:hover { filter:brightness(.98); }
      .btn-primary { background:#1f6feb; color:white; border-color:#1f6feb; }
      .btn-ghost { background:white; border:1px dashed #cfd8e3; }
      .status { margin-top:8px; font-size:0.95rem; }
      .risk-badge { display:inline-block; padding:6px 8px; border-radius:8px; font-weight:700; margin-left:8px; }
      .risk-low { background:#e8fff0; color:#066b24; }
      .risk-high { background:#ffecec; color:#8b0000; }
      #resultInner { padding:14px; }
      #answerText pre { margin:0; }
      #answerText h1, #answerText h2, #answerText h3 { margin:8px 0; }
      #answerText ul { padding-left:20px; margin:6px 0; }
      .history-item { padding:8px; border-bottom:1px solid #f3f4f6; cursor:pointer; }
      .history-item:hover { background:#fbfcfe; }
      .small { font-size:0.9rem; color:#666; }
      .btn-small { padding:6px 8px; border-radius:6px; font-size:0.9rem; }
      details pre { white-space:pre-wrap; word-break:break-word; }
      .ask-btn-row { display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap;}
      .file-name { font-size:0.9rem; color:#444; margin-left:8px; }
      /* Make result area larger and scroll inside it (but page not long-scrolling) */
      #resultCard { display:flex; flex-direction:column; gap:12px; min-height:240px; max-height:560px; overflow:auto; padding:8px; }
      #answerText { line-height:1.5; }
      @media (max-width: 980px) {
        .grid-3 { grid-template-columns: 1fr; }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>Intelligent Document Assistant</h1>

      <div class="grid-3">
        <!-- Upload card -->
        <div class="card">
          <h2>Upload Document</h2>
          <form id="uploadForm" onsubmit="return false;">
            <input type="file" name="file" id="fileInputMain" accept=".pdf,.docx,.txt" />
            <div style="margin-top:12px;">
              <button id="uploadBtnMain" class="btn">Upload &amp; Ingest</button>
            </div>
          </form>
          <div class="status" id="uploadStatusMain"></div>

          <div style="margin-top:14px;">
            <strong>Uploaded files:</strong>
            <ul id="uploadedList" class="muted" style="margin-top:6px; padding-left:16px;"></ul>
          </div>

          <div style="margin-top:12px;">
            <small class="muted">Supported: .pdf, .docx, .txt</small>
          </div>
        </div>

        <!-- Ask / Result card -->
        <div class="card">
          <h2>Ask a Question</h2>
          <textarea id="query" placeholder="Ask about obligations, notice periods, risky clauses..." rows="6"></textarea>

          <!-- three buttons row: Ask, Upload (ask-area), Upload & Ingest -->
          <div class="ask-btn-row" style="margin-top:8px;">
            <button id="ask" class="btn btn-primary">Ask</button>

            <!-- Ask-area upload (hidden file input used only for ask-card) -->
            <input type="file" id="askFileInput" accept=".pdf,.docx,.txt" style="display:none" />
            <button id="askUploadBtn" class="btn btn-ghost">Upload DOCX</button>
            <button id="askUploadIngestBtn" class="btn">Upload &amp; Ingest</button>

            <span id="askFileName" class="file-name"></span>
            <span id="queryStatus" class="muted" style="margin-left:auto"></span>
          </div>

          <div style="margin-top:18px;">
            <h3>Response:</h3>

            <div id="noResult" class="muted">No result yet. Ask a question to see the assistant's answer here.</div>

            <div id="resultCard" style="display:none; margin-top:8px;">
              <div class="card" id="resultInner">
                <div id="answerText" style="font-size:1rem;color:#111"></div>

                <div style="margin-top:12px;">
                  <strong>Sources used:</strong> <span id="sourceCount">0</span>
                </div>

                <div style="margin-top:8px;">
                  <strong>Risk:</strong> <span id="riskSummary" class="muted">-</span>
                  <span id="escalationBadge"></span>
                </div>

                <div style="margin-top:12px;">
                  <details>
                    <summary>Raw meta (click to expand)</summary>
                    <pre id="rawJson" style="max-height:240px;overflow:auto;background:#0d1117;color:#e6eef8;padding:8px;border-radius:6px"></pre>
                  </details>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- History / Export card -->
        <div class="card" id="historyCard">
          <h2>History</h2>
          <div style="display:flex;gap:8px;margin-bottom:8px;">
            <button id="refreshHistory" class="btn btn-small">Refresh</button>
            <button id="exportLangsmith" class="btn btn-small">Export for LangSmith</button>
            <button id="clearHistory" class="btn btn-small" title="Clear UI selections">Clear</button>
          </div>

          <div id="historyList" style="max-height:480px; overflow:auto; border-radius:6px; border:1px solid #f3f4f6;"></div>

          <div id="historyDetail" style="margin-top:12px;display:none;">
            <h3 style="margin:8px 0 6px 0;">Detail</h3>
            <div id="historyDetailContent" class="small"></div>
            <div style="margin-top:8px;">
              <button id="replayBtn" class="btn btn-small">Replay Question</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- marked + DOMPurify -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

    <script>
      // helper to render markdown safely
      function renderMarkdownToHtml(md) {
        try {
          const rawHtml = marked.parse(md || "");
          const clean = DOMPurify.sanitize(rawHtml);
          return clean;
        } catch (e) {
          return '<pre style="color:red">Markdown rendering error</pre>';
        }
      }

      // ---------- MAIN UPLOAD (left card) ----------
      document.getElementById('uploadBtnMain').addEventListener('click', async (e) => {
        e.preventDefault();
        const input = document.getElementById('fileInputMain');
        if (!input.files || input.files.length === 0) {
          alert('Choose a file first (left Upload area).');
          return;
        }
        const file = input.files[0];
        const fd = new FormData();
        fd.append('file', file);
        const status = document.getElementById('uploadStatusMain');
        status.innerText = 'Uploading...';
        try {
          const resp = await fetch('/upload', { method: 'POST', body: fd });
          const data = await resp.json();
          if (resp.ok && data.ok) {
            status.innerHTML = `<span style="color:green">${data.message}</span>`;
            const ul = document.getElementById('uploadedList');
            const li = document.createElement('li');
            li.textContent = file.name + ' — ingested';
            ul.prepend(li);
            loadHistory();
          } else {
            status.innerHTML = `<span style="color:red">${data.message || data.error || 'Upload failed'}</span>`;
          }
        } catch (err) {
          status.innerHTML = `<span style="color:red">Network error: ${err}</span>`;
        }
      });

      // ---------- ASK-AREA upload behavior ----------
      const askFileInput = document.getElementById('askFileInput');
      const askFileNameEl = document.getElementById('askFileName');

      // When "Upload DOCX" clicked, trigger hidden file input
      document.getElementById('askUploadBtn').addEventListener('click', (e) => {
        e.preventDefault();
        askFileInput.click();
      });

      // when file chosen via ask-area input, show filename but do not upload yet
      askFileInput.addEventListener('change', () => {
        if (askFileInput.files && askFileInput.files.length > 0) {
          askFileNameEl.textContent = askFileInput.files[0].name + ' (will be uploaded when you Ask or press Upload & Ingest)';
        } else {
          askFileNameEl.textContent = '';
        }
      });

      // Ask-area "Upload & Ingest" button - upload immediately
      document.getElementById('askUploadIngestBtn').addEventListener('click', async (e) => {
        e.preventDefault();
        if (!askFileInput.files || askFileInput.files.length === 0) {
          alert('Choose a file first (use Upload DOCX to select).');
          return;
        }
        const file = askFileInput.files[0];
        const fd = new FormData();
        fd.append('file', file);
        const queryStatus = document.getElementById('queryStatus');
        queryStatus.innerText = 'Uploading file...';
        try {
          const resp = await fetch('/upload', { method: 'POST', body: fd });
          const data = await resp.json();
          queryStatus.innerText = '';
          if (resp.ok && data.ok) {
            askFileNameEl.textContent = file.name + ' — ingested';
            loadHistory();
            alert('File uploaded and ingested successfully.');
          } else {
            alert('Upload failed: ' + (data.message || data.error || 'unknown'));
          }
        } catch (err) {
          queryStatus.innerText = '';
          alert('Network error: ' + err);
        }
      });

      // ---------- ASK (combined behavior) ----------
      document.getElementById('ask').addEventListener('click', async () => {
        const q = document.getElementById('query').value.trim();
        if (!q) return alert('Write a question');

        const queryStatus = document.getElementById('queryStatus');
        queryStatus.innerText = 'Working...';

        // If ask-area has a file selected, upload it first so retriever includes it
        if (askFileInput.files && askFileInput.files.length > 0) {
          const file = askFileInput.files[0];
          const fd = new FormData();
          fd.append('file', file);
          queryStatus.innerText = 'Uploading supporting file...';
          try {
            const upResp = await fetch('/upload', { method: 'POST', body: fd });
            const upData = await upResp.json();
            if (upResp.ok && upData.ok) {
              // mark file as uploaded in UI
              askFileNameEl.textContent = file.name + ' — ingested';
              // refresh uploaded list
              const ul = document.getElementById('uploadedList');
              const li = document.createElement('li');
              li.textContent = file.name + ' — ingested';
              ul.prepend(li);
            } else {
              queryStatus.innerText = '';
              return alert('Failed to upload supporting file: ' + (upData.message || upData.error));
            }
          } catch (err) {
            queryStatus.innerText = '';
            return alert('Upload error: ' + err);
          }
        }

        // now run the query
        queryStatus.innerText = 'Querying model...';
        try {
          const resp = await fetch('/query', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ query: q })
          });
          const data = await resp.json();
          queryStatus.innerText = '';

          if (resp.ok && !data.error) {
            document.getElementById('noResult').style.display = 'none';
            document.getElementById('resultCard').style.display = 'block';

            // Render Markdown answer
            const html = renderMarkdownToHtml(data.answer || "(no answer)");
            document.getElementById('answerText').innerHTML = html;

            document.getElementById('sourceCount').innerText = data.source_count ?? 0;

            const risk = data.risk || { overall_score: 0, found: [] };
            if (risk.overall_score >= 0.7) {
              document.getElementById('escalationBadge').innerHTML = '<span class="risk-badge risk-high">Auto-Escalated</span>';
            } else {
              document.getElementById('escalationBadge').innerHTML = '<span class="risk-badge risk-low">No escalation</span>';
            }
            document.getElementById('riskSummary').innerText = `score ${risk.overall_score} — ${risk.found.map(x=>x.term).join(', ') || 'none'}`;

            document.getElementById('rawJson').innerText = JSON.stringify(data, null, 2);

            // Clear ask file selection (we've uploaded it already)
            askFileInput.value = '';
            // refresh history to include this saved interaction
            loadHistory();
          } else {
            alert('Error: ' + (data.error || data.message || JSON.stringify(data)));
            queryStatus.innerText = '';
          }
        } catch (err) {
          queryStatus.innerText = '';
          alert('Network error: ' + err);
        }
      });

      // ---------- HISTORY ----------
      async function loadHistory() {
        const div = document.getElementById('historyList');
        div.innerHTML = '<div class="small" style="padding:8px">Loading...</div>';
        try {
          const r = await fetch('/history?limit=200');
          const rows = await r.json();
          div.innerHTML = '';
          if (!rows || rows.length === 0) {
            div.innerHTML = '<div class="small" style="padding:8px">No history yet.</div>';
            return;
          }
          rows.forEach(item => {
            const el = document.createElement('div');
            el.className = 'history-item';
            el.dataset.id = item.id;
            const qShort = (item.question || "").length > 80 ? (item.question || "").slice(0,77) + "..." : (item.question || "");
            el.innerHTML = `<strong>#${item.id}</strong> ${DOMPurify.sanitize(qShort)}<div class="small">${new Date(item.created_at).toLocaleString()} • sources:${item.source_count} • risk:${(item.risk?.overall_score ?? 0)}</div>`;
            el.addEventListener('click', () => showHistoryDetail(item.id));
            div.appendChild(el);
          });
        } catch (e) {
          div.innerHTML = `<div class="small" style="padding:8px">Failed to load: ${e}</div>`;
        }
      }

      async function showHistoryDetail(id) {
        const resp = await fetch(`/history/${id}`);
        if (!resp.ok) {
          alert('Failed to load history item');
          return;
        }
        const data = await resp.json();
        const container = document.getElementById('historyDetailContent');

        const answerHtml = DOMPurify.sanitize(marked.parse(data.answer || ""));
        const questionHtml = DOMPurify.sanitize(marked.parseInline(data.question || ""));

        container.innerHTML = `
          <div><strong>Question:</strong><div>${questionHtml}</div></div>
          <div style="margin-top:8px"><strong>Answer:</strong><div>${answerHtml}</div></div>
          <div style="margin-top:8px" class="small"><strong>Created:</strong> ${new Date(data.created_at).toLocaleString()}</div>
          <div class="small" style="margin-top:6px;"><strong>Escalated:</strong> ${data.escalated ? 'Yes' : 'No'} • <strong>Sources:</strong> ${data.source_count}</div>
          <details style="margin-top:8px"><summary>Raw context</summary><pre>${DOMPurify.sanitize(data.context || "")}</pre></details>
        `;

        document.getElementById('historyDetail').style.display = 'block';
        document.getElementById('replayBtn').onclick = () => {
          document.getElementById('query').value = data.question;
          document.getElementById('ask').click();
        };
      }

      document.getElementById('refreshHistory').addEventListener('click', loadHistory);
      document.getElementById('exportLangsmith').addEventListener('click', async () => {
        try {
          const r = await fetch('/export/langsmith');
          const data = await r.json();
          const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'langsmith_export.json';
          a.click();
          URL.revokeObjectURL(url);
        } catch (e) {
          alert('Export failed: ' + e);
        }
      });

      document.getElementById('clearHistory').addEventListener('click', () => {
        document.getElementById('historyDetail').style.display = 'none';
        document.getElementById('historyList').innerHTML = '';
      });

      // initial load
      loadHistory();
    </script>
  </body>
</html>
